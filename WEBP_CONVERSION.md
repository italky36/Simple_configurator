# Конвертация SVG в WebP

## Проблема

SVG файлы с встроенными растровыми изображениями (base64) могут быть огромными (8+ MB каждый) и не поддаются оптимизации через `scour`. Такие файлы медленно загружаются и занимают много места в кэше.

## Решение: Конвертация в WebP

WebP - современный формат изображений с отличным сжатием:
- **Уменьшение размера**: 8.7 MB SVG → ~500KB-1MB WebP (90%+ экономии)
- **Поддержка прозрачности**: Как PNG, но с лучшим сжатием
- **Широкая поддержка**: Все современные браузеры

### Компромисс

- ✅ **Огромная экономия места** (в 10-20 раз меньше)
- ✅ **Быстрая загрузка** (меньше трафика)
- ❌ **Теряется масштабируемость** (фиксированное разрешение)

Для изображений дизайнов машин это приемлемо - они показываются в фиксированном размере на странице.

## Установка зависимостей

```bash
pip install pillow cairosvg
```

## Использование

### 1. Конвертировать все SVG в кэше

```bash
cd /srv/Simple_configurator

# Конвертировать все файлы (оригиналы сохраняются)
python scripts/convert_svg_to_webp.py --recursive app/static/cache/machines/

# Или конвертировать и удалить оригиналы (экономия места)
python scripts/convert_svg_to_webp.py --recursive --delete-original app/static/cache/machines/
```

### 2. Конвертировать одну директорию

```bash
# Конвертировать все SVG для одной машины
python scripts/convert_svg_to_webp.py app/static/cache/machines/10/
```

### 3. Настроить качество и разрешение

```bash
# Высокое разрешение для Retina дисплеев (3000px ширина)
python scripts/convert_svg_to_webp.py --width 3000 --quality 90 app/static/cache/machines/

# Стандартное разрешение (2000px ширина) - по умолчанию
python scripts/convert_svg_to_webp.py app/static/cache/machines/

# Меньший размер файла (1500px ширина, качество 80)
python scripts/convert_svg_to_webp.py --width 1500 --quality 80 app/static/cache/machines/
```

## Рекомендуемые настройки

Для дизайнов машин на Tilda:
- **Ширина**: 2000px (хорошо для Retina дисплеев)
- **Качество**: 85 (баланс между размером и качеством)

```bash
python scripts/convert_svg_to_webp.py --recursive --width 2000 --quality 85 app/static/cache/machines/
```

## Обновление базы данных

После конвертации нужно обновить пути в базе данных с `.svg` на `.webp`:

```bash
cd /srv/Simple_configurator

# Запустить скрипт обновления (создаётся отдельно)
python scripts/update_paths_to_webp.py
```

## Автоматическая конвертация новых файлов

Чтобы новые файлы автоматически конвертировались в WebP при загрузке, можно:

1. **Включить конвертацию в media_cache.py** - новые SVG автоматически конвертируются
2. **Хранить оригиналы в Seafile** - на случай если понадобятся векторы

## Сравнение размеров

Типичные результаты для дизайнов машин:

| Формат | Размер | Описание |
|--------|--------|----------|
| SVG (оригинал) | 8.7 MB | Со встроенными изображениями |
| SVG (scour) | 8.6 MB | Оптимизация не помогает |
| WebP (quality 85) | ~600 KB | **93% экономии** |
| WebP (quality 90) | ~800 KB | Лучше качество |
| PNG | ~2-3 MB | Для сравнения |

## Проверка результата

После конвертации:

```bash
# Посмотреть размеры
ls -lh app/static/cache/machines/10/*.webp

# Сравнить с оригиналами
du -sh app/static/cache/machines/
```

## Откат (если нужно вернуться к SVG)

Если оригинальные SVG не были удалены:

```bash
# Удалить WebP файлы
find app/static/cache/machines/ -name "*.webp" -delete

# Обновить базу данных обратно на .svg
python scripts/update_paths_to_svg.py
```

## FAQ

**Q: Потеряется ли качество?**
A: При ширине 2000px и quality 85 - визуально неотличимо от оригинала для веб-просмотра.

**Q: WebP поддерживается во всех браузерах?**
A: Да, с 2020 года поддерживается везде (Chrome, Firefox, Safari, Edge).

**Q: Можно ли масштабировать WebP как SVG?**
A: Нет, WebP растровый формат. Но для отображения на сайте в фиксированном размере это не проблема.

**Q: Что делать с новыми файлами?**
A: Можно настроить автоматическую конвертацию в media_cache.py или конвертировать вручную периодически.
